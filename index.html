<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rabbit-Wolf Game</title>
    <style>
      body,
      html {
        width: 100%;
        margin: 0;
      }
      .container {
        background-color: rgb(135, 94, 218);
        width: 96, 5%;
        padding: 30px;
        margin: 0 auto;
      }
      .body {
        border-bottom: 2px solid rgb(35, 144, 122);
      }
      .block {
        border: 1px solid black;
        border-radius: 10px;
        background-color: rgb(35, 144, 122);
        margin: 0 auto;
        width: 450px;
        height: 40px;
      }
      .block div {
        border: 1px solid black;
        width: 70px;
        height: 70px;
        float: left;
        margin: 2px;
        background-color: rgb(155, 205, 195);
      }
      .buttons {
        width: 500px;
        height: 70px;
        margin: 30px auto 0 auto;
        text-align: center;
      }
      img {
        width: 70px;
        height: 70px;
      }
      button,
      select {
        padding: 7px;
        margin-right: 20px;
        border-radius: 10px;
        background-color: rgb(35, 144, 122);
        color: white;
        font-size: 15px;
      }
      h3 {
        color: white;
        font-size: 30px;
        text-align: center;
      }
      .overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.7);
        display: none;
      }
      .alert {
        position: fixed;
        top: 10%;
        margin-top: -50px;
        left: 37%;
        margin-left: -100px;
        width: 700px;
        height: 700px;
        text-align: center;
        padding: 10px;
        background-color: rgba(255, 255, 255, 0.7);
      }
      .alert button {
        bottom: 1px;
      }
      #message {
        padding-top: 40px;
        padding-bottom: 70px;
        font-size: 43px;
        font-weight: bold;
        color: rgb(204, 34, 8);
      }
      .movement {
        width: 350px;
        margin: 20px auto;
        text-align: center;
      }
      .up,
      .down {
        width: 250px;
        margin: 7px auto;
      }
      .left,
      .right {
        width: 125px;
        margin: 0 auto;
      }
      .newGame {
        width: 280px;
        margin: 10px auto;
      }
    </style>
  </head>
  <body>
    <div class="container" id="container">
      <h3>HELP THE BUNNY GET HOME</h3>
    </div>
    <script>
      const FREE_ID = 0
      const RABBIT_ID = 1
      const HOUSE_ID = 2
      const WOLF_ID = 3
      const FENCE_ID = 4
      const X = 0
      const Y = 1
      const UNIT_SIZE = 76
      let blockNum = 1
      const container = document.getElementById("container")

      const IMAGES = {
        [FREE_ID]: "Images/1x1.png",
        [RABBIT_ID]: "Images/rabbit.png",
        [HOUSE_ID]: "Images/house.png",
        [WOLF_ID]: "Images/wolf.png",
        [FENCE_ID]: "Images/fence.png",
      }

      createGameUI(blockNum)

      function onClickStartButton() {
        const select = document.getElementById(`size_${blockNum}`)
        const sizeValue = select.value
        setSizeOfGameGrid(sizeValue)
        const primaryArray = drawPrimaryArray(sizeValue)
        const newMultiArr = setPlayersLocation(primaryArray, sizeValue)
        console.log(newMultiArr)
        createPlayGround(newMultiArr)
        createMovementButtons(newMultiArr)
        createAddNewGameButton()
      }

      function addRabbitMovementEvent(multiArr, event) {
        let actionVal = []
        if (event === "ArrowUp") {
          actionVal = [-1, 0]
        }
        if (event === "ArrowDown") {
          actionVal = [1, 0]
        }
        if (event === "ArrowRight") {
          actionVal = [0, 1]
        }
        if (event === "ArrowLeft") {
          actionVal = [0, -1]
        }
        let multiArrAfterRabbitMovement = moveRabbit(multiArr, actionVal)
        let multiArrAfterWolfMovement = moveWolfs(multiArrAfterRabbitMovement)
        console.log(multiArrAfterWolfMovement)
        createPlayGround(multiArrAfterWolfMovement)
      }

      function createMultidimensionalArray(blockSize) {
        const multiArray = []
        for (let i = 0; i < blockSize; i++) {
          multiArray[i] = []
          for (let j = 0; j < blockSize; j++) {
            multiArray[i][j] = FREE_ID
          }
        }
        return multiArray
      }

      function setPlayersLocation(multiArr, sizeVal) {
        setCharacterLocation(multiArr, RABBIT_ID)
        setCharacterLocation(multiArr, HOUSE_ID)
        for (let i = 0; i < (sizeVal / 100) * 60; i++) {
          setCharacterLocation(multiArr, WOLF_ID)
        }
        for (let i = 0; i < (sizeVal / 100) * 40; i++) {
          setCharacterLocation(multiArr, FENCE_ID)
        }
        return multiArr
      }

      function setCharacterLocation(multiArr, locValue) {
        const [x, y] = getRandomLoc(multiArr)
        multiArr[x][y] = locValue
        return multiArr
      }

      function getRandomLoc(multiArr) {
        const rawIndex = Math.floor(Math.random() * multiArr.length)
        const colIndex = Math.floor(Math.random() * multiArr.length)
        if (multiArr[rawIndex][colIndex] === FREE_ID) {
          return [rawIndex, colIndex]
        } else {
          return getRandomLoc(multiArr)
        }
      }

      function drawPrimaryArray(sizeValue) {
        const playersList = createMultidimensionalArray(sizeValue)
        return playersList
      }

      function moveRabbit(multiArr, actionVal) {
        const locationList = getIndexOfCurrentCharacter(multiArr, RABBIT_ID)
        locationList.forEach((loc) => {
          const [locX, locY] = loc
          const [actionValX, actionValY] = actionVal
          const step = multiArr.length - 1
          let x = "",
            y = ""
          if (actionValX === -1 && locX === 0) {
            ;[x, y] = [locX + step, locY + actionValY]
          } else if (actionValX === 1 && locX === step) {
            ;[x, y] = [locX - step, locY + actionValY]
          } else if (actionValY === 1 && locY === step) {
            ;[x, y] = [locX + actionValX, locY - step]
          } else if (actionValY === -1 && locY === 0) {
            ;[x, y] = [locX + actionValX, locY + step]
          } else {
            ;[x, y] = [locX + actionValX, locY + actionValY]
          }
          if (multiArr[x][y] === 0) {
            multiArr[locX][locY] = FREE_ID
            multiArr[x][y] = RABBIT_ID
          } else if (multiArr[x][y] === HOUSE_ID) {
            multiArr[locX][locY] = FREE_ID
            youWon()
          }
        })
        return multiArr
      }

      function moveWolfs(multiArr) {
        const rabbitLocList = getIndexOfCurrentCharacter(multiArr, RABBIT_ID)
        console.log(rabbitLocList)
        const wolfLocList = getIndexOfCurrentCharacter(multiArr, WOLF_ID)
        const rabbitCoord = rabbitLocList[X]

        const moveWolf = (wolf) => {
          const steps = findWolfsSteps(multiArr, wolf)
          if (steps !== undefined) {
            const distances = steps.map((step) =>
              calculateDistance(rabbitCoord, step)
            )
            const index = distances.indexOf(Math.min(...distances))
            const nearPoint = steps[index]
            if (nearPoint !== undefined) {
              multiArr[nearPoint[X]][nearPoint[Y]] = WOLF_ID
              multiArr[wolf[X]][wolf[Y]] = FREE_ID
            }
          }
        }
        wolfLocList.forEach(moveWolf)
        return multiArr
      }

      function calculateDistance(location1, location2) {
        if (location1 !== undefined && location1 !== undefined) {
          return Math.sqrt(
            Math.pow(location1[X] - location2[X], 2) +
              Math.pow(location1[Y] - location2[Y], 2)
          )
        }
      }

      function findWolfsSteps(multiArr, location) {
        const [x, y] = location

        const up = [x - 1, y]
        const down = [x + 1, y]
        const right = [x, y + 1]
        const left = [x, y - 1]

        const allDirections = [up, down, right, left]
        const isInRange = ([x, y]) =>
          x >= 0 && x < multiArr.length && y >= 0 && y < multiArr.length
        const steps = allDirections.filter(isInRange)
        let findRebbitNearWolf = steps.filter(
          (step) => multiArr[step[X]][step[Y]] === RABBIT_ID
        )
        if (findRebbitNearWolf.length !== 0) {
          youLost()
        } else {
          return steps.filter((step) => multiArr[step[X]][step[Y]] === FREE_ID)
        }
      }

      function getIndexOfCurrentCharacter(array, charValue) {
        const findInArray = function (accumulator, row, x) {
          row.forEach((element, y) => {
            if (element === charValue) {
              accumulator.push([x, y])
            }
          })
          return accumulator
        }
        return array.reduce(findInArray, [])
      }

      function setSizeOfGameGrid(size) {
        const block = document.getElementById(`block_${blockNum}`)
        const blocksize = UNIT_SIZE * size + "px"
        block.style.width = blocksize
        block.style.height = blocksize
      }

      function createPlayGround(multiArr) {
        deleteAllChildElements()
        const block = document.getElementById(`block_${blockNum}`)

        for (let i = 0; i < multiArr.length; i++) {
          for (let j = 0; j < multiArr.length; j++) {
            let div = document.createElement("div")
            block.appendChild(div)
            const cellValue = multiArr[i][j]
            div.appendChild(getImage(cellValue))
          }
        }
      }

      function getImage(character) {
        const player = document.createElement("img")
        player.src = IMAGES[character]
        return player
      }

      function deleteAllChildElements() {
        const block = document.getElementById(`block_${blockNum}`)
        while (block.lastElementChild) {
          block.removeChild(block.lastElementChild)
        }
      }

      function createDivElement(name, id) {
        const divName = document.createElement("div")
        divName.id = `${name}_${id}`
        divName.classList.add(name)
        return divName
      }

      function createButtonElement(name, id) {
        const btn = document.createElement("button")
        btn.id = `${name}_${id}`
        btn.innerHTML = name.toUpperCase()
        return btn
      }

      function createGameUI(blockNum) {
        const body = createDivElement("body", blockNum)
        const buttons = createDivElement("buttons", blockNum)
        const startbtn = createButtonElement("start", blockNum)
        container.appendChild(body).appendChild(buttons).appendChild(startbtn)

        const sizeArray = [" 5 x 5 ", " 7 x 7 ", " 10 x 10 "]
        const selectList = document.createElement("select")
        selectList.id = `size_${blockNum}`
        buttons.appendChild(selectList)
        for (var i = 0; i < sizeArray.length; i++) {
          var option = document.createElement("option")
          option.text = sizeArray[i]
          option.value = `${sizeArray[i][1]}${sizeArray[i][2]}`
          console.log(option.value)
          selectList.appendChild(option)
        }

        const block = createDivElement("block", blockNum)
        body.appendChild(block)
        const movementBlock = createDivElement("movement", blockNum)
        body.appendChild(movementBlock)

        const overlay = createDivElement("overlay", blockNum)
        body.appendChild(overlay)

        const divAlert = createDivElement("alert", blockNum)
        const message = document.createElement("p")
        message.id = "message"
        overlay.appendChild(divAlert).appendChild(message)
        const startAgainbtn = createButtonElement("start again", blockNum)
        divAlert.appendChild(startAgainbtn)

        startbtn.onclick = onClickStartButton
      }

      function createMovementButtons(multiArr) {
        const movementdiv = document.querySelector(`#movement_${blockNum}`)
        while (movementdiv.lastElementChild) {
          movementdiv.removeChild(movementdiv.lastElementChild)
        }
        const upbtn = createButtonElement("up", blockNum)
        upbtn.classList.add("up")
        movementdiv.appendChild(upbtn)
        upbtn.onclick = function () {
          addRabbitMovementEvent(multiArr, "ArrowUp")
        }

        const leftbtn = createButtonElement("left", blockNum)
        leftbtn.classList.add("left")
        movementdiv.appendChild(leftbtn)
        leftbtn.onclick = function () {
          addRabbitMovementEvent(multiArr, "ArrowLeft")
        }

        const rightbtn = createButtonElement("right", blockNum)
        rightbtn.classList.add("right")
        movementdiv.appendChild(rightbtn)
        rightbtn.onclick = function () {
          addRabbitMovementEvent(multiArr, "ArrowRight")
        }

        const downbtn = createButtonElement("down", blockNum)
        downbtn.classList.add("down")
        movementdiv.appendChild(downbtn)
        downbtn.onclick = function () {
          addRabbitMovementEvent(multiArr, "ArrowDown")
        }
      }

      function createAddNewGameButton() {
        const movementdiv = document.querySelector(`#movement_${blockNum}`)
        const addNewGameBtn = createButtonElement("ADD NEW GAME", blockNum)
        addNewGameBtn.classList.add("newGame")
        movementdiv.appendChild(addNewGameBtn)
        addNewGameBtn.onclick = function () {
          blockNum += 1
          createGameUI(blockNum)
          console.log(blockNum)
        }
      }

      function youLost() {
        document.querySelector(".block").style.display = "none"
        document.querySelector(".overlay").style.display = "block"
        document.querySelector(".alert").style.backgroundImage =
          "url('Images/sadrabbit.png')"
        document.getElementById("message").innerHTML = '"UPSSS..YOU LOST !!!"'
      }

      function youWon() {
        document.querySelector(".overlay").style.display = "block"
        document.querySelector(".alert").style.backgroundImage =
          "url('Images/balloons.png')"
        document.getElementById("message").innerHTML =
          '"CONGRATULATIONS.. YOU WON !!!"'
        document.querySelector(".block").style.display = "none"
      }

      function gameStatusAlert() {
        document.querySelector(".alert").style.backgroundRepeat = "no-repeat"
        document.querySelector(".alert").style.backgroundSize = "100%"
        document.querySelector(".alert button").addEventListener(
          "click",
          function () {
            onClickStartButton()
            document.querySelector(".overlay").style.display = "none"
            document.querySelector(".block").style.display = "block"
          },
          false
        )
      }

      gameStatusAlert()
    </script>
  </body>
</html>
