<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game</title>
    <style>
        .body {
            background-color: rgb(135, 94, 218);
            width: 100%;
            padding: 20px 0 100px 0;
        }
        .container {
            border: 1px solid black;
            background-color: rgb(35, 144, 122);
            margin: 0 auto;
            width: 500px;
            height: 20px;
    
        }
        .container div {
            border: 1px solid black;
            width: 70px;
            height: 70px;
            float: left;
            margin: 2px;
            background-color: rgb(155, 205, 195);
        }
        .buttons {
            width: 500px;
            height: 90px;
            margin: 0 auto;
            text-align: center;
        }
        img {
            width: 70px;
            height: 70px;
        }
        button,
        select {
            padding: 7px;
            margin-right: 20px;
            border-radius: 10px;
            background-color: rgb(35, 144, 122);
            color: white;
            font-size: 15px;
        }
        h3 {
            color: white;
        }
    </style>
</head>
<body>
    <div class="body" id="body">
        <div class="buttons">
            <h3>HELP THE BUNNY GET HOME</h3>
            <button id="start">START</button>
            <select name="size" id="size">
                <option value="5"> 5 * 5 </option>
                <option value="7"> 7 * 7 </option>
                <option value="10"> 10 * 10 </option>
            </select>
        </div>
        <div class="container" id="container"></div>
    </div>
    <script>
        const defaultVal = 0;
        const rabbitNum = 1;
        const houseNum = 2;
        const wolfNum = 3;
        const fenceNum = 4;
        
        function addStartButtonEvent() {
            const startBtn = document.getElementById('start');
            startBtn.onclick = function () {
                const select = document.getElementById("size");
                const sizeValue = select.value;
                const primaryArray = drawPrimaryArray(sizeValue)
                const newMultiArr = setPlayersLocation(primaryArray, sizeValue)
                console.log(newMultiArr)
                
                addRabbitMovementEventListeners(newMultiArr)    
            };

            function addRabbitMovementEventListeners(multiArr) {
                document.addEventListener("keydown", function(event) {

                    let actionVal = []
                    if(event.key === 'ArrowUp'){
                        actionVal = [-1, 0]
                    }
                    if(event.key === 'ArrowDown'){
                        actionVal = [1, 0]
                    }
                    if(event.key === 'ArrowRight'){
                        actionVal = [0, 1]
                    }
                    if (event.key === 'ArrowLeft') {
                        actionVal = [0, -1]
                    }
                    const multiArrAfterRabbitMovement = moveRabbit(multiArr, actionVal)
                    const multiArrAfterWolfMovement = moveWolf(multiArr)
                    console.log(multiArrAfterWolfMovement);
                    findRabbitNeighbors(multiArrAfterWolfMovement)
                    // delayedAlert(multiArrAfterWolfMovement)  
                })
            }
        }
        function delayedAlert(multiArr) {
            let timeoutID
            timeoutID = window.setTimeout(findRabbitNeighbors(multiArr) , 3000);
        }
        function createMultidimensionalArray(blockSize){
            const multiArray = [];
            for (let i = 0; i < blockSize; i++) {
                multiArray[i] = [];
                for (let j = 0; j < blockSize; j++) {
                    multiArray[i][j] = defaultVal;
                }
            }
            return multiArray;
        }

        function setPlayersLocation(multiArr, sizeVal) {
            setCharacterLocation(multiArr, rabbitNum)
            setCharacterLocation(multiArr, houseNum)
            for(let i = 0; i < (sizeVal / 100 * 60); i++){
                setCharacterLocation(multiArr, wolfNum)
            }
            for (let i = 0; i < (sizeVal / 100 * 40); i++) {
                setCharacterLocation(multiArr, fenceNum)
            }
            return multiArr;
        }

        function setCharacterLocation(multiArr, value) {
            const [x, y] = getRandomLoc(multiArr);
            multiArr[x][y] = value
            return multiArr;   
        }

        function getRandomLoc(multiArr) {
            const rawIndex = Math.floor(Math.random() * multiArr.length);
            const colIndex = Math.floor(Math.random() * multiArr.length);
            if ( multiArr[rawIndex][colIndex] === 0 ){
                return [rawIndex, colIndex]
            }else {
               return getRandomLoc(multiArr) 
            }
            
        }

        function drawPrimaryArray (sizeValue) {
            const playersList = createMultidimensionalArray(sizeValue)
            return playersList;
        }
        
        function moveRabbit(multiArr, action) {
            const locationList = getIndexOfCurrentCharacter(multiArr, rabbitNum)
            locationList.forEach(item => {
                const [a, b] = item
                const [c, d] = action
                const step = multiArr.length - 1
                let x = '', y = '';
                if (c === -1 && a === 0) {
                    [x, y] = [a + step, b + d]
                }else if (c === 1 && a === step) {
                    [x, y] = [a - step, b + d]
                }else if (d === 1 && b === step) {
                    [x, y] = [a + c, b - step]
                }else if (d === -1 && b === 0) {
                    [x, y] = [a + c, b + step]
                }else {
                    [x, y] = [a + c, b + d]
                }
                if ( multiArr[x][y] === 0 ) {
                    multiArr[a][b] = defaultVal
                    multiArr[x][y] = rabbitNum
                }else if ( multiArr[x][y] === houseNum ){
                    alert("CONGRATULATIONS..YOU WON !!!");
                    
                }  
            })
            return multiArr;    
        }

        function moveWolf(multiArr){
            const rabbitLocList = getIndexOfCurrentCharacter( multiArr, rabbitNum )
            const wolfLocList = getIndexOfCurrentCharacter( multiArr, wolfNum )
            const [x, y] = rabbitLocList[0]
            wolfLocList.forEach( elem => {
                const steps = findWolfsSteps(multiArr, elem)
                let distances = []
                if( steps.length !== 0 ) {
                    steps.forEach(elem => {
                        distances.push(calculateDistance([x, y], elem))   
                    })
                    const index = distances.indexOf(Math.min(...distances));
                    const nearPoint = steps[index]
                    multiArr[nearPoint[0]][nearPoint[1]] = wolfNum
                    multiArr[elem[0]][elem[1]] = defaultVal
                }
            })
            return multiArr;
        }
        
        function findRabbitNeighbors(multiArr) {
            const rabbitLocList = getIndexOfCurrentCharacter(multiArr, rabbitNum)
            const [x, y] = rabbitLocList[0]
            let steps = [[x - 1, y], [x + 1, y], [x, y + 1], [x, y - 1]]
            steps = steps.filter(item => item[0] >= 0 && item[0] < multiArr.length &&
                                        item[1] >= 0 && item[1] < multiArr.length &&
                                        multiArr[item[0]][item[1]] === wolfNum)
            if ( steps.length !== 0 ) {
                alert("UPSSS..YOU LOST !!!");
            }
        }
        
        function calculateDistance(location1, location2){
            return Math.sqrt(Math.pow((location1[0] - location2[0]), 2) + 
                            Math.pow((location1[1] - location2[1]), 2 ))
        }

        function findWolfsSteps( multiArr, location ) {
            const [x, y] = location
            const up = [x-1, y]
            const down = [x+1, y]
            const right = [x, y+1]
            const left = [x, y-1]
            let steps = [up, down, right, left]
            steps = steps.filter( item => item[0] >= 0 && item[0] < multiArr.length && 
                                        item[1] >= 0 && item[1] < multiArr.length && 
                                        multiArr[item[0]][item[1]] === defaultVal )
            return steps
        }
 
        function getIndexOfCurrentCharacter(array, charValue) {
            const findInArray = function (accumulator, row, x) {
                row.forEach((element, y) => {
                    if ( element === charValue ) {
                        accumulator.push([x, y])
                    }
                })
                return accumulator
            }
            return array.reduce(findInArray, [])
        }
        
        addStartButtonEvent()
    </script>
</body>
</html>
