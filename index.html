<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rabbit-Wolf Game</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container" id="container">
      <h3>HELP THE BUNNY GET HOME</h3>
    </div>
    <script>
      const FREE_ID = 0
      const RABBIT_ID = 1
      const HOUSE_ID = 2
      const WOLF_ID = 3
      const FENCE_ID = 4
      const X = 0
      const Y = 1
      const UNIT_SIZE = 76
      let blockNum = 1
      let movementInterval
      const container = document.getElementById("container")

      const IMAGES = {
        [FREE_ID]: "Images/1x1.png",
        [RABBIT_ID]: "Images/rabbit.png",
        [HOUSE_ID]: "Images/house.png",
        [WOLF_ID]: "Images/wolf.png",
        [FENCE_ID]: "Images/fence.png",
      }

      createGameUI(blockNum)

      function onClickStartButton(blockNum) {
        const select = document.getElementById(`size_${blockNum}`)
        const sizeValue = select.value
        setSizeOfGameGrid(sizeValue, blockNum)
        const primaryArray = drawPrimaryArray(sizeValue)
        const newMultiArr = setAllPlayersLocation(primaryArray, sizeValue)
        const gameState = {
          gameArray: newMultiArr,
          isGameRunning: true,
          gameBlock: blockNum,
        }
        createPlayGround(gameState)
        createMovementButtons(gameState.gameBlock)
        callMovmentButtonsEvents(gameState)
        createAddNewBoardButton(gameState.gameBlock)
        clearInterval(movementInterval)
        setTimoutForWolvesMovement(gameState)
      }

      function setRabbitMovementDirection(direction) {
        let actionVal = []
        if (direction === "ArrowUp") {
          actionVal = [-1, 0]
        }
        if (direction === "ArrowDown") {
          actionVal = [1, 0]
        }
        if (direction === "ArrowRight") {
          actionVal = [0, 1]
        }
        if (direction === "ArrowLeft") {
          actionVal = [0, -1]
        }
        return actionVal
      }

      function drawWolvesMovement(gameState) {
        moveWolves(gameState)
        createPlayGround(gameState)
      }

      function setTimoutForWolvesMovement(gameState) {
        movementInterval = setInterval(drawWolvesMovement, 1300, gameState)
      }

      function drawRabbitMovement(gameState, direction) {
        const actionVal = setRabbitMovementDirection(direction)
        const multiArrAfterRabbitMovement = moveRabbit(gameState, actionVal)
        createPlayGround(gameState)
      }

      function createMultidimensionalArray(blockSize) {
        const multiArray = []
        for (let i = 0; i < blockSize; i++) {
          multiArray[i] = []
          for (let j = 0; j < blockSize; j++) {
            multiArray[i][j] = FREE_ID
          }
        }
        return multiArray
      }

      function setAllPlayersLocation(multiArr, sizeVal) {
        setCharacterLocation(multiArr, RABBIT_ID)
        setCharacterLocation(multiArr, HOUSE_ID)
        for (let i = 0; i < (sizeVal / 100) * 60; i++) {
          setCharacterLocation(multiArr, WOLF_ID)
        }
        for (let i = 0; i < (sizeVal / 100) * 40; i++) {
          setCharacterLocation(multiArr, FENCE_ID)
        }
        return multiArr
      }

      function setCharacterLocation(multiArr, locValue) {
        const [x, y] = getRandomLocation(multiArr)
        multiArr[x][y] = locValue
        return multiArr
      }

      function getRandomLocation(multiArr) {
        const rawIndex = Math.floor(Math.random() * multiArr.length)
        const colIndex = Math.floor(Math.random() * multiArr.length)
        if (multiArr[rawIndex][colIndex] === FREE_ID) {
          return [rawIndex, colIndex]
        } else {
          return getRandomLocation(multiArr)
        }
      }

      function drawPrimaryArray(sizeValue) {
        const playersList = createMultidimensionalArray(sizeValue)
        return playersList
      }

      function moveRabbit(gameState, diractionVal) {
        const multiArr = gameState.gameArray
        const blockNum = gameState.gameBlock
        if (gameState.isGameRunning) {
          const locationList = getIndexOfCurrentCharacter(multiArr, RABBIT_ID)
          locationList.forEach((loc) => {
            const [locX, locY] = loc
            const [directionX, directionY] = diractionVal
            const step = multiArr.length - 1
            let x = "",
              y = ""
            if (directionX === -1 && locX === 0) {
              ;[x, y] = [locX + step, locY + directionY]
            } else if (directionX === 1 && locX === step) {
              ;[x, y] = [locX - step, locY + directionY]
            } else if (directionY === 1 && locY === step) {
              ;[x, y] = [locX + directionX, locY - step]
            } else if (directionY === -1 && locY === 0) {
              ;[x, y] = [locX + directionX, locY + step]
            } else {
              ;[x, y] = [locX + directionX, locY + directionY]
            }
            if (multiArr[x][y] === 0) {
              multiArr[locX][locY] = FREE_ID
              multiArr[x][y] = RABBIT_ID
            } else if (multiArr[x][y] === HOUSE_ID) {
              multiArr[locX][locY] = FREE_ID
              gameState.isGameRunning = false
              youWon(blockNum)
            }
          })
        }
        return multiArr
      }

      function moveWolves(gameState) {
        const multiArr = gameState.gameArray
        const blockNum = gameState.gameBlock
        if (gameState.isGameRunning) {
          const rabbitLocList = getIndexOfCurrentCharacter(multiArr, RABBIT_ID)
          const wolfLocList = getIndexOfCurrentCharacter(multiArr, WOLF_ID)
          const rabbitCoord = rabbitLocList[0]

          const moveWolf = (wolf) => {
            const steps = findWolvesSteps(gameState, wolf)
            if (steps.length !== 0) {
              const distances = steps.map((step) =>
                calculateDistance(rabbitCoord, step)
              )
              const index = distances.indexOf(Math.min(...distances))
              const nearPoint = steps[index]
              multiArr[nearPoint[X]][nearPoint[Y]] = WOLF_ID
              multiArr[wolf[X]][wolf[Y]] = FREE_ID
            } else {
              gameState.isGameRunning = false
              youLost(blockNum)
            }
          }
          wolfLocList.forEach(moveWolf)
        }
        return multiArr
      }

      function calculateDistance(location1, location2) {
        if (location1 !== undefined && location1 !== undefined) {
          return Math.sqrt(
            Math.pow(location1[X] - location2[X], 2) +
              Math.pow(location1[Y] - location2[Y], 2)
          )
        }
      }

      function getNearCellsOf([x, y]) {
        return [
          [x - 1, y],
          [x + 1, y],
          [x, y + 1],
          [x, y - 1],
        ]
      }

      function findWolvesSteps(gameState, location) {
        const multiArr = gameState.gameArray
        const blockNum = gameState.gameBlock
        const [x, y] = location

        const allNeighbourDirections = getNearCellsOf([x, y])
        const isInRange = ([x, y]) =>
          x >= 0 && x < multiArr.length && y >= 0 && y < multiArr.length
        const steps = allNeighbourDirections.filter(isInRange)
        const findRebbitNearWolf = steps.filter(
          (step) => multiArr[step[X]][step[Y]] === RABBIT_ID
        )
        if (findRebbitNearWolf.length !== 0) {
          return []
        } else {
          return steps.filter((step) => multiArr[step[X]][step[Y]] === FREE_ID)
        }
      }

      function getIndexOfCurrentCharacter(array, charValue) {
        const findInArray = function (accumulator, row, x) {
          row.forEach((element, y) => {
            if (element === charValue) {
              accumulator.push([x, y])
            }
          })
          return accumulator
        }
        return array.reduce(findInArray, [])
      }

      function setSizeOfGameGrid(size, blockNum) {
        const block = document.getElementById(`block_${blockNum}`)
        const blocksize = UNIT_SIZE * size + "px"
        block.style.width = blocksize
        block.style.height = blocksize
      }

      function createPlayGround(gameState) {
        const multiArr = gameState.gameArray
        const blockNum = gameState.gameBlock
        deleteAllChildElements(blockNum)
        const block = document.getElementById(`block_${blockNum}`)

        for (let i = 0; i < multiArr.length; i++) {
          for (let j = 0; j < multiArr.length; j++) {
            let div = document.createElement("div")
            block.appendChild(div)
            const cellValue = multiArr[i][j]
            div.appendChild(getImage(cellValue))
          }
        }
      }

      function getImage(character) {
        const player = document.createElement("img")
        player.src = IMAGES[character]
        return player
      }

      function deleteAllChildElements(blockNum) {
        const block = document.getElementById(`block_${blockNum}`)
        while (block.lastElementChild) {
          block.removeChild(block.lastElementChild)
        }
      }

      function createDivElement(name, id) {
        const divName = document.createElement("div")
        divName.id = `${name}_${id}`
        divName.classList.add(name)
        return divName
      }

      function createButtonElement(name, id, divToAppend) {
        const btn = document.createElement("button")
        btn.id = `${name}_${id}`
        btn.classList.add(`${name}`)
        btn.innerHTML = name.toUpperCase()
        divToAppend.appendChild(btn)
      }

      function createGameUI(blockNum) {
        const body = createDivElement("body", blockNum)
        const buttons = createDivElement("buttons", blockNum)
        createButtonElement("start", blockNum, buttons)
        container.appendChild(body).appendChild(buttons)

        const sizeArray = [" 5 x 5 ", " 7 x 7 ", " 10 x 10 "]
        const selectList = document.createElement("select")
        selectList.id = `size_${blockNum}`
        buttons.appendChild(selectList)
        for (var i = 0; i < sizeArray.length; i++) {
          var option = document.createElement("option")
          option.text = sizeArray[i]
          option.value = `${sizeArray[i][1]}${sizeArray[i][2]}`
          selectList.appendChild(option)
        }

        const block = createDivElement("block", blockNum)
        const movementBlock = createDivElement("movement", blockNum)
        const overlay = createDivElement("overlay", blockNum)
        body.append(block, movementBlock, overlay)

        const divAlert = createDivElement("alert", blockNum)
        const message = document.createElement("p")
        message.id = `message_${blockNum}`
        message.classList.add("message")
        overlay.appendChild(divAlert).appendChild(message)
        createButtonElement("start_again", blockNum, divAlert)

        document
          .querySelector(`#start_${blockNum}`)
          .addEventListener("click", function () {
            onClickStartButton(blockNum)
          })
      }

      function createMovementButtons(blockNum) {
        const movementdiv = document.querySelector(`#movement_${blockNum}`)
        while (movementdiv.lastElementChild) {
          movementdiv.removeChild(movementdiv.lastElementChild)
        }
        createButtonElement("up", blockNum, movementdiv)
        createButtonElement("left", blockNum, movementdiv)
        createButtonElement("right", blockNum, movementdiv)
        createButtonElement("down", blockNum, movementdiv)
      }

      function addMovmentButtonEvent(gameState, clickedButton, direction) {
        const btn = document.getElementById(
          `${clickedButton}_${gameState.gameBlock}`
        )
        btn.onclick = function () {
          drawRabbitMovement(gameState, direction)
        }
      }

      function callMovmentButtonsEvents(gameState) {
        addMovmentButtonEvent(gameState, "up", "ArrowUp")
        addMovmentButtonEvent(gameState, "left", "ArrowLeft")
        addMovmentButtonEvent(gameState, "right", "ArrowRight")
        addMovmentButtonEvent(gameState, "down", "ArrowDown")
      }

      function createAddNewBoardButton(blockNum) {
        const movementdiv = document.querySelector(`#movement_${blockNum}`)
        createButtonElement("new_board", blockNum, movementdiv)
        const newBoardButton = document.querySelector(`#new_board_${blockNum}`)
        newBoardButton.addEventListener("click", function () {
          blockNum += 1
          createGameUI(blockNum)
          movementdiv.removeChild(newBoardButton)
        })
      }

      function setgameStatusAlertStyle(blockNum) {
        document.querySelector(`#alert_${blockNum}`).style.backgroundRepeat =
          "no-repeat"
        document.querySelector(`#alert_${blockNum}`).style.backgroundSize =
          "100%"
      }

      function hideGameBlock(blockNum, blockName) {
        document.querySelector(`#block_${blockNum}`).style.display = "none"
        document.querySelector(`#movement_${blockNum}`).style.display = "none"
        document.querySelector(`#buttons_${blockNum}`).style.display = "none"
      }
      function showGameBlock(blockNum) {
        document.querySelector(`#block_${blockNum}`).style.display = "block"
        document.querySelector(`#movement_${blockNum}`).style.display = "block"
        document.querySelector(`#buttons_${blockNum}`).style.display = "block"
      }

      function drawGameOverBlock(blockNum, image, message) {
        document.querySelector(`#overlay_${blockNum}`).style.display = "block"
        document.querySelector(`#alert_${blockNum}`).style.backgroundImage =
          image
        document.getElementById(`message_${blockNum}`).innerHTML = message
        hideGameBlock(blockNum)
        document
          .getElementById(`start_again_${blockNum}`)
          .addEventListener("click", function () {
            onClickStartButton(blockNum)
            document.querySelector(`#overlay_${blockNum}`).style.display =
              "none"
            showGameBlock(blockNum)
          })
        setgameStatusAlertStyle(blockNum)
        clearInterval(movementInterval)
      }

      function youLost(blockNum) {
        const image = "url('Images/sadrabbit.png')"
        const message = '"UPSSS..YOU LOST !!!"'
        drawGameOverBlock(blockNum, image, message)
      }

      function youWon(blockNum) {
        const image = "url('Images/balloons.png')"
        const message = '"CONGRATULATIONS.. YOU WON !!!"'
        drawGameOverBlock(blockNum, image, message)
      }
    </script>
  </body>
</html>
