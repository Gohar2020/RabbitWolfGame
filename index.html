<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rabbit-Wolf Game</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container" id="container">
      <h3>HELP THE BUNNY GET HOME</h3>
    </div>
    <script>
      const WOLF_MOVE_MIN_MILISEC = 2000
      const FREE_ID = 0
      const RABBIT_ID = 1
      const HOUSE_ID = 2
      const WOLF_ID = 3
      const FENCE_ID = 4
      const X = 0
      const Y = 1
      const UNIT_SIZE = 76
      let gameBoardNum = 0
      const GAME_STATES = {}
      const container = document.getElementById("container")

      const IMAGES = {
        [FREE_ID]: "Images/1x1.png",
        [RABBIT_ID]: "Images/rabbit.png",
        [HOUSE_ID]: "Images/house.png",
        [WOLF_ID]: "Images/wolf.png",
        [FENCE_ID]: "Images/fence.png",
      }

      function createNewGameButton() {
        newGameBtn = "<button id='newGame'>NEW GAME</button>"
        container.insertAdjacentHTML("beforeend", newGameBtn)
      }
      function addNewGameButtonEvent(gameBoardNum) {
        const btn = document.getElementById("newGame")
        btn.addEventListener("click", function () {
          createGameBody(Object.keys(GAME_STATES).length)
          addStartButtonEvent(gameBoardNum)
          gameBoardNum += 1
        })
      }
      function createGameBody(gameBoardNum) {
        const perGameBody = `
          <div class="gameBody" id="body_${gameBoardNum}">
            <div class="buttons">
              <button class="start" id="start">START</button>
              <select name="size" id="size" class="size">
                <option value="5">5 * 5</option>
                <option value="7">7 * 7</option>
                <option value="10">10 * 10</option>
              </select>
            </div>
            <div class="board" id="board"></div>
            <div class="movement" id="movement"></div>
          </div>
          <div class="gameOverWindow" id="gameOverWindow_${gameBoardNum}">
            <div class="alert">
              <p id="message" class="message"></p><br/>
              <button class="startAgain">START AGAIN</button>
            </div>
          </div>`
        container.insertAdjacentHTML("beforeend", perGameBody)
      }

      function getBoardDivElement(gameBoardNum, elementClassName) {
        const element = document.querySelector(
          `#body_${gameBoardNum} .${elementClassName}`
        )
        return element
      }

      function addStartButtonEvent(gameBoardNum) {
        const btn = getBoardDivElement(gameBoardNum, "start")
        btn.addEventListener("click", function () {
          onClickStartButton(gameBoardNum)
        })
      }

      function getGameOverWindowElement(gameBoardNum, elementClassName) {
        const element = document.querySelector(
          `#gameOverWindow_${gameBoardNum} .${elementClassName}`
        )
        return element
      }

      function setgameStatusAlertStyle(gameBoardNum) {
        const alert = getGameOverWindowElement(gameBoardNum, "alert")
        alert.style.backgroundRepeat = "no-repeat"
        alert.style.backgroundSize = "100%"
      }

      function drawGameOverBlock(gameState, image, message) {
        const gameBoardNum = gameState.gameBoardNum
        const window = document.getElementById(`gameOverWindow_${gameBoardNum}`)
        window.style.display = "block"
        const alert = getGameOverWindowElement(gameBoardNum, "alert")
        alert.style.backgroundImage = image
        const mess = getGameOverWindowElement(gameBoardNum, "message")
        mess.innerHTML = message
        const body = document.getElementById(`body_${gameBoardNum}`)
        body.style.display = "none"
        const startAgainBtn = getGameOverWindowElement(
          gameBoardNum,
          "startAgain"
        )
        startAgainBtn.addEventListener("click", function () {
          onClickStartButton(gameBoardNum)
          window.style.display = "none"
          body.style.display = "block"
        })
        setgameStatusAlertStyle(gameBoardNum)
      }

      function setSizeOfGameGrid(sizeValue, gameBoardNum) {
        const board = getBoardDivElement(gameBoardNum, "board")
        const boardsize = UNIT_SIZE * sizeValue + "px"
        board.style.width = boardsize
        board.style.height = boardsize
      }

      function createMultidimensionalArray(boardSize) {
        const gameArray = []
        for (let i = 0; i < boardSize; i++) {
          gameArray[i] = []
          for (let j = 0; j < boardSize; j++) {
            gameArray[i][j] = FREE_ID
          }
        }
        return gameArray
      }

      function drawPrimaryArray(sizeValue) {
        const playersList = createMultidimensionalArray(sizeValue)
        return playersList
      }

      function getRandomLocation(gameArray) {
        const rawIndex = Math.floor(Math.random() * gameArray.length)
        const colIndex = Math.floor(Math.random() * gameArray.length)
        if (gameArray[rawIndex][colIndex] === FREE_ID) {
          return [rawIndex, colIndex]
        } else {
          return getRandomLocation(gameArray)
        }
      }

      function setCharacterLocation(gameArray, characterId) {
        const [x, y] = getRandomLocation(gameArray)
        gameArray[x][y] = characterId
        return gameArray
      }

      function setAllPlayersLocation(gameArray, sizeVal) {
        setCharacterLocation(gameArray, RABBIT_ID)
        setCharacterLocation(gameArray, HOUSE_ID)
        for (let i = 0; i < (sizeVal / 100) * 60; i++) {
          setCharacterLocation(gameArray, WOLF_ID)
        }
        for (let i = 0; i < (sizeVal / 100) * 40; i++) {
          setCharacterLocation(gameArray, FENCE_ID)
        }
        return gameArray
      }

      function deleteAllChildElements(gameBoardNum) {
        const board = getBoardDivElement(gameBoardNum, "board")
        while (board.lastElementChild) {
          board.removeChild(board.lastElementChild)
        }
      }
      function getImage(character) {
        const player = document.createElement("img")
        player.src = IMAGES[character]
        return player
      }

      function createPlayGround(gameState) {
        const gameArray = gameState.gameArray
        const gameBoardNum = gameState.gameBoardNum
        deleteAllChildElements(gameBoardNum)
        const board = getBoardDivElement(gameBoardNum, "board")

        for (let i = 0; i < gameArray.length; i++) {
          for (let j = 0; j < gameArray.length; j++) {
            let div = document.createElement("div")
            board.appendChild(div)
            const cellValue = gameArray[i][j]
            div.appendChild(getImage(cellValue))
          }
        }
      }

      function createButtonElement(name, id, divToAppend) {
        const btn = document.createElement("button")
        btn.id = `${name}_${id}`
        btn.classList.add(`${name}`)
        btn.innerHTML = name.toUpperCase()
        divToAppend.appendChild(btn)
      }

      function createMovementButtons(gameBoardNum) {
        const movementdiv = getBoardDivElement(gameBoardNum, "movement")
        while (movementdiv.lastElementChild) {
          movementdiv.removeChild(movementdiv.lastElementChild)
        }
        createButtonElement("up", gameBoardNum, movementdiv)
        createButtonElement("left", gameBoardNum, movementdiv)
        createButtonElement("right", gameBoardNum, movementdiv)
        createButtonElement("down", gameBoardNum, movementdiv)
      }

      function setRabbitMovementDirections() {
        return (dirValues = {
          ["Up"]: [-1, 0],
          ["Down"]: [1, 0],
          ["Right"]: [0, 1],
          ["Left"]: [0, -1],
        })
      }

      function getIndexOfCurrentCharacter(gameArray, characterId) {
        const findInArray = function (accumulator, row, x) {
          row.forEach((element, y) => {
            if (element === characterId) {
              accumulator.push([x, y])
            }
          })
          return accumulator
        }
        return gameArray.reduce(findInArray, [])
      }

      function youLost(gameState) {
        const image = "url('Images/sadrabbit.jpg')"
        const message = '"UPSSS..YOU LOST !!!"'
        drawGameOverBlock(gameState, image, message)
        // gameState.timers.forEach(clearInterval)
      }

      function youWon(gameState) {
        const image = "url('Images/balloons.png')"
        const message = '"CONGRATULATIONS.. YOU WON !!!"'
        drawGameOverBlock(gameState, image, message)
        // gameState.timers.forEach(clearInterval)
      }

      function setPointsOutOfRangeDirections([x, y], maxStep, direction) {
        const movementEndPoints = {
          ["Up"]: [x + maxStep, y],
          ["Down"]: [x - maxStep, y],
          ["Left"]: [x, y + maxStep],
          ["Right"]: [x, y - maxStep],
        }
        const newLocation = movementEndPoints[direction]
        x = newLocation[X]
        y = newLocation[Y]
        return [x, y]
      }

      function moveRabbit(gameState, direction, directionVal) {
        if (gameState.isGameRunning === false) {
          return
        }
        const gameArray = gameState.gameArray
        const rabbitLocations = getIndexOfCurrentCharacter(gameArray, RABBIT_ID)
        const [rabbitLocX, rabbitLocY] = rabbitLocations[0]
        const [directionX, directionY] = directionVal
        const maxStep = gameArray.length - 1
        let [x, y] = [rabbitLocX + directionX, rabbitLocY + directionY]

        const isInRange = ([x, y]) =>
          x >= 0 && x <= maxStep && y >= 0 && y <= maxStep
        if (isInRange([x, y]) === false) {
          ;[x, y] = setPointsOutOfRangeDirections(
            rabbitLocations[0],
            maxStep,
            direction
          )
        }
        if (gameArray[x][y] === FREE_ID) {
          gameArray[rabbitLocX][rabbitLocY] = FREE_ID
          gameArray[x][y] = RABBIT_ID
        } else if (gameArray[x][y] === HOUSE_ID) {
          gameArray[rabbitLocX][rabbitLocY] = FREE_ID
          gameState.isGameRunning = false
          youWon(gameState)
        }
      }

      function drawRabbitMovement(gameState, direction) {
        const actionVal = setRabbitMovementDirections()[direction]
        moveRabbit(gameState, direction, actionVal)
        createPlayGround(gameState)
      }

      function addMovmentButtonEvent(gameState, clickedButton, direction) {
        const btn = document.getElementById(
          `${clickedButton}_${gameState.gameBoardNum}`
        )
        btn.onclick = function () {
          drawRabbitMovement(gameState, direction)
        }
      }

      function callMovmentButtonsEvents(gameState) {
        addMovmentButtonEvent(gameState, "up", "Up")
        addMovmentButtonEvent(gameState, "left", "Left")
        addMovmentButtonEvent(gameState, "right", "Right")
        addMovmentButtonEvent(gameState, "down", "Down")
      }

      // function moveWolvesByRandomInterval(gameState) {
      //   const multiArr = gameState.gameArray

      //   const wolfLocList = getIndexOfCurrentCharacter(multiArr, WOLF_ID)

      //   const moveWolf = (wolf) => {
      //     const rabbitLocList = getIndexOfCurrentCharacter(multiArr, RABBIT_ID)
      //     const rabbitCoord = rabbitLocList[0]

      //     if (gameState.isGameRunning === false) {
      //       return
      //     }

      //     const steps = findWolvesSteps(gameState, wolf)
      //     if (steps.length !== 0) {
      //       const distances = steps.map((step) =>
      //         calculateDistance(rabbitCoord, step)
      //       )
      //       const index = distances.indexOf(Math.min(...distances))
      //       const nearPoint = steps[index]
      //       multiArr[nearPoint[X]][nearPoint[Y]] = WOLF_ID
      //       multiArr[wolf[X]][wolf[Y]] = FREE_ID
      //       createPlayGround(gameState)
      //     } else {
      //       gameState.isGameRunning = false
      //       youLost(gameState)
      //     }
      //   }

      //   gameState.timers = wolfLocList.map((wolf) => {
      //     const randomMilisec = Math.round(Math.random() * 500)
      //     return setInterval(
      //       moveWolf,
      //       WOLF_MOVE_MIN_MILISEC + randomMilisec,
      //       wolf
      //     )
      //   })
      // }

      function onClickStartButton(gameBoardNum) {
        const select = getBoardDivElement(gameBoardNum, "size")
        const sizeValue = select.value
        setSizeOfGameGrid(sizeValue, gameBoardNum)
        const primaryArray = drawPrimaryArray(sizeValue)
        const newGameArray = setAllPlayersLocation(primaryArray, sizeValue)

        const gameState = {
          gameArray: newGameArray,
          isGameRunning: true,
          gameBoardNum,
        }
        GAME_STATES[gameBoardNum] = gameState
        createPlayGround(gameState)
        createMovementButtons(gameState.gameBoardNum)
        callMovmentButtonsEvents(gameState)
        // moveWolvesByRandomInterval(gameState)
      }

      createNewGameButton()
      addNewGameButtonEvent(gameBoardNum)
    </script>
  </body>
</html>
